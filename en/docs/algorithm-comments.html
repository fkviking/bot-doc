<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>8. Algorithm Notes | Documentation for Viking&#39;s trading robots</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/github-markdown-css/2.2.1/github-markdown.css">
    <link rel="icon" href="/bot-doc/favicon.ico">
    <meta name="description" content="User guide, algorithm description and API">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/bot-doc/assets/css/0.styles.6701afdc.css" as="style"><link rel="preload" href="/bot-doc/assets/js/app.83ad7943.js" as="script"><link rel="preload" href="/bot-doc/assets/js/2.838bb34b.js" as="script"><link rel="preload" href="/bot-doc/assets/js/45.f472a853.js" as="script"><link rel="preload" href="/bot-doc/assets/js/26.6f356218.js" as="script"><link rel="prefetch" href="/bot-doc/assets/js/1.afddc6e9.js"><link rel="prefetch" href="/bot-doc/assets/js/11.0da1be66.js"><link rel="prefetch" href="/bot-doc/assets/js/12.e55e8208.js"><link rel="prefetch" href="/bot-doc/assets/js/13.4efbd1a1.js"><link rel="prefetch" href="/bot-doc/assets/js/14.ddc6c31a.js"><link rel="prefetch" href="/bot-doc/assets/js/15.38fcf87c.js"><link rel="prefetch" href="/bot-doc/assets/js/16.c824be6d.js"><link rel="prefetch" href="/bot-doc/assets/js/17.bc69b124.js"><link rel="prefetch" href="/bot-doc/assets/js/18.892cf449.js"><link rel="prefetch" href="/bot-doc/assets/js/19.2cb09572.js"><link rel="prefetch" href="/bot-doc/assets/js/20.06660988.js"><link rel="prefetch" href="/bot-doc/assets/js/21.341785c2.js"><link rel="prefetch" href="/bot-doc/assets/js/22.a9cd9df1.js"><link rel="prefetch" href="/bot-doc/assets/js/23.944d81d0.js"><link rel="prefetch" href="/bot-doc/assets/js/24.5f00b0c1.js"><link rel="prefetch" href="/bot-doc/assets/js/25.c23c90cc.js"><link rel="prefetch" href="/bot-doc/assets/js/27.3727a712.js"><link rel="prefetch" href="/bot-doc/assets/js/28.7eadd82b.js"><link rel="prefetch" href="/bot-doc/assets/js/29.9b8ce8ee.js"><link rel="prefetch" href="/bot-doc/assets/js/3.9ce79b6a.js"><link rel="prefetch" href="/bot-doc/assets/js/30.44e495e8.js"><link rel="prefetch" href="/bot-doc/assets/js/31.70e4c415.js"><link rel="prefetch" href="/bot-doc/assets/js/32.2eaba1b6.js"><link rel="prefetch" href="/bot-doc/assets/js/33.14efe842.js"><link rel="prefetch" href="/bot-doc/assets/js/34.d53a4518.js"><link rel="prefetch" href="/bot-doc/assets/js/35.d18c0881.js"><link rel="prefetch" href="/bot-doc/assets/js/36.72b6350e.js"><link rel="prefetch" href="/bot-doc/assets/js/37.e62fc9c8.js"><link rel="prefetch" href="/bot-doc/assets/js/38.bdb0e081.js"><link rel="prefetch" href="/bot-doc/assets/js/39.2086f6a6.js"><link rel="prefetch" href="/bot-doc/assets/js/4.7a0878b4.js"><link rel="prefetch" href="/bot-doc/assets/js/40.827f5d16.js"><link rel="prefetch" href="/bot-doc/assets/js/41.220ebbd7.js"><link rel="prefetch" href="/bot-doc/assets/js/42.2c97abb1.js"><link rel="prefetch" href="/bot-doc/assets/js/43.97a6d394.js"><link rel="prefetch" href="/bot-doc/assets/js/44.2291f6d7.js"><link rel="prefetch" href="/bot-doc/assets/js/46.dfa89cf0.js"><link rel="prefetch" href="/bot-doc/assets/js/47.56652151.js"><link rel="prefetch" href="/bot-doc/assets/js/48.ec655cfb.js"><link rel="prefetch" href="/bot-doc/assets/js/49.45859187.js"><link rel="prefetch" href="/bot-doc/assets/js/5.a4b9db76.js"><link rel="prefetch" href="/bot-doc/assets/js/50.c01ce370.js"><link rel="prefetch" href="/bot-doc/assets/js/51.bb84e970.js"><link rel="prefetch" href="/bot-doc/assets/js/52.a37f1349.js"><link rel="prefetch" href="/bot-doc/assets/js/6.216be7b2.js"><link rel="prefetch" href="/bot-doc/assets/js/7.a0739e8f.js"><link rel="prefetch" href="/bot-doc/assets/js/8.4ce14e89.js"><link rel="prefetch" href="/bot-doc/assets/js/vendors~docsearch.1f8fb848.js">
    <link rel="stylesheet" href="/bot-doc/assets/css/0.styles.6701afdc.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/bot-doc/en/" class="home-link router-link-active"><img src="/bot-doc/images/vkg_logo.svg" alt="Documentation for Viking's trading robots" class="logo"> <span class="site-name can-hide">Documentation for Viking's trading robots</span></a> <div class="links"><!----> <nav class="nav-links can-hide"><div class="nav-item"><a href="/bot-doc/en/docs/introduction.html" class="nav-link">
  Documentation
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Languages" class="dropdown-title"><span class="title">🇺🇸 EN</span> <span class="arrow down"></span></button> <button type="button" aria-label="Languages" class="mobile-dropdown-title"><span class="title">🇺🇸 EN</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/bot-doc/docs/algorithm-comments.html" class="nav-link">
  🇷🇺 RU
</a></li><li class="dropdown-item"><!----> <a href="/bot-doc/en/docs/algorithm-comments.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  🇺🇸 EN
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/bot-doc/en/docs/introduction.html" class="nav-link">
  Documentation
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Languages" class="dropdown-title"><span class="title">🇺🇸 EN</span> <span class="arrow down"></span></button> <button type="button" aria-label="Languages" class="mobile-dropdown-title"><span class="title">🇺🇸 EN</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/bot-doc/docs/algorithm-comments.html" class="nav-link">
  🇷🇺 RU
</a></li><li class="dropdown-item"><!----> <a href="/bot-doc/en/docs/algorithm-comments.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  🇺🇸 EN
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span></span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/bot-doc/en/docs/change-history.html" class="sidebar-link">1. Change Log</a></li><li><a href="/bot-doc/en/docs/introduction.html" class="sidebar-link">2. About the Platform</a></li><li><a href="/bot-doc/en/docs/interface.html" class="sidebar-link">3. Website Interface</a></li><li><a href="/bot-doc/en/docs/getting-started.html" class="sidebar-link">4. Getting Started</a></li><li><a href="/bot-doc/en/docs/stable-work.html" class="sidebar-link">5. Providing Feedback</a></li><li><a href="/bot-doc/en/docs/creating-connection.html" class="sidebar-link">6. Adding Connections</a></li><li><a href="/bot-doc/en/docs/params-description.html" class="sidebar-link">7. Parameters Description</a></li><li><a href="/bot-doc/en/docs/algorithm-comments.html" aria-current="page" class="active sidebar-link">8. Algorithm Notes</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/bot-doc/en/docs/algorithm-comments.html#_8-1-specifics-of-using-market-depth-order-book-data" class="sidebar-link">8.1. Specifics of Using Market Depth (Order Book) Data</a></li><li class="sidebar-sub-header"><a href="/bot-doc/en/docs/algorithm-comments.html#_8-2-move-order-support" class="sidebar-link">8.2. Move Order Support</a></li><li class="sidebar-sub-header"><a href="/bot-doc/en/docs/algorithm-comments.html#_8-3-rules-for-moving-lim-sell-and-lim-buy" class="sidebar-link">8.3. Rules for moving LimSell and LimBuy</a></li><li class="sidebar-sub-header"><a href="/bot-doc/en/docs/algorithm-comments.html#_8-4-behavior-of-orders-re-posted-based-on-sl-or-timer" class="sidebar-link">8.4. Behavior of Orders Re-Posted Based on SL or Timer</a></li><li class="sidebar-sub-header"><a href="/bot-doc/en/docs/algorithm-comments.html#_8-5-financial-result-calculation" class="sidebar-link">8.5. Financial Result Calculation</a></li><li class="sidebar-sub-header"><a href="/bot-doc/en/docs/algorithm-comments.html#_8-6-on-pricing-of-second-leg-orders" class="sidebar-link">8.6. On Pricing of Second-Leg Orders</a></li><li class="sidebar-sub-header"><a href="/bot-doc/en/docs/algorithm-comments.html#_8-7-on-order-submission-volumes" class="sidebar-link">8.7. On Order Submission Volumes</a></li></ul></li><li><a href="/bot-doc/en/docs/order-error.html" class="sidebar-link">9. Order Submission, Cancellation, and Modification Errors</a></li><li><a href="/bot-doc/en/docs/c-api.html" class="sidebar-link">10. Formulas in C++</a></li><li><a href="/bot-doc/en/docs/api.html" class="sidebar-link">11. WebSocket API</a></li><li><a href="/bot-doc/en/docs/comparison.html" class="sidebar-link">12. Comparison of C++ Formulas and WebSocket API</a></li><li><a href="/bot-doc/en/docs/faq.html" class="sidebar-link">13. Frequently Asked Questions</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_8-algorithm-notes" tabindex="-1"><a href="#_8-algorithm-notes" class="header-anchor">#</a> <div class="anchor-container"><span id="algorithm-notes" class="anchor-target"></span> <a href="#algorithm-notes" title="Копировать ссылку" class="anchor-link">#</a></div> 8. Algorithm Notes</h1> <p>This page contains detailed descriptions of non-obvious aspects of the bot algorithm.</p> <h2 id="_8-1-specifics-of-using-market-depth-order-book-data" tabindex="-1"><a href="#_8-1-specifics-of-using-market-depth-order-book-data" class="header-anchor">#</a> <div class="anchor-container"><span id="specifics-of-using-market-depth-(order-book)-data" class="anchor-target"></span> <a href="#specifics-of-using-market-depth-(order-book)-data" title="Копировать ссылку" class="anchor-link">#</a></div> 8.1. Specifics of Using Market Depth (Order Book) Data</h2> <p>The bot uses order book tables/streams to obtain instrument prices. A key characteristic of working with order books is that the exchange does not send a fully formed, real-time order book. To minimize data transmission volume, the exchange first sends a snapshot of the order book for an instrument at a given moment, followed by incremental updates reflecting changes. The bot does not build order books for all available instruments — only for those used in active portfolios. Therefore, to add a new instrument to the list of those for which order books are maintained, the bot must re-open the snapshot stream and then apply incremental updates from the update stream. During the processing of the snapshot stream, the system temporarily suspends order book updates for all active instruments. Updates resume only after the snapshot stream is fully processed and closed, and incremental updates have resumed. The processing time depends on the number of instruments in the snapshot and the depth of the order books. As a result, during the order book reinitialization, price data for certain instruments may be temporarily unavailable. Reinitialization is required in most connection types because full order book snapshots or complete order logs are typically delivered over a single data stream. This means it is not possible to subscribe to data for specific instruments — data for all instruments is received, but only selected ones are actively used by the system.</p> <p>The order book in the bot may be reinitialized in the following cases:</p> <ul><li>Add a new portfolio;</li> <li>Adding a new instrument to a portfolio;</li> <li>Clearing the <code>Disabled</code> flag on a portfolio;</li> <li>Message sequence gaps in the incremental order book update stream over UDP connections to exchanges (the more portfolios and instruments you have, the higher the likelihood of such gaps).</li></ul> <p>This results in a temporary suspension of trading across all portfolios using instruments from the affected exchange. This behavior is not a malfunction—it is an expected part of the system's operation</p> <h2 id="_8-2-move-order-support" tabindex="-1"><a href="#_8-2-move-order-support" class="header-anchor">#</a> <div class="anchor-container"><span id="move-order-support" class="anchor-target"></span> <a href="#move-order-support" title="Копировать ссылку" class="anchor-link">#</a></div> 8.2. Move Order Support</h2> <p>On certain connections, the bot supports submitting a specialized exchange order called a Move Order. This feature helps reduce the number of transactions and improve the trade-to-transaction ratio — particularly valuable in quoting (market-making) strategies — while also enhancing order persistence in the market. Since the specifics of using this command vary across markets and connection types, its application may be limited to the first leg of a portfolio or extended to instruments in both legs, depending on the connection. Currently, submission of this command is implemented for FIX connections on the Moscow Exchange stock and currency markets, as well as for TWIME connections on the Moscow Exchange derivatives market.</p> <p>Using the Move Order command is optional for supported connections. This feature can be disabled when creating a new transactional connection.</p> <h2 id="_8-3-rules-for-moving-lim-sell-and-lim-buy" tabindex="-1"><a href="#_8-3-rules-for-moving-lim-sell-and-lim-buy" class="header-anchor">#</a> <div class="anchor-container"><span id="rules-for-moving-lim_sell-and-lim_buy" class="anchor-target"></span> <a href="#rules-for-moving-lim_sell-and-lim_buy" title="Копировать ссылку" class="anchor-link">#</a></div> 8.3. Rules for moving Lim_Sell and Lim_Buy</h2> <p>Signal prices <a href="/bot-doc/en/docs/params-description.html#p.lim_s">Lim_Sell</a> and <a href="/bot-doc/en/docs/params-description.html#p.lim_s">Lim_Buy</a> are moved only upon trade execution in the <a href="/bot-doc/en/docs/params-description.html#s.is_first">Is first</a> instrument of the portfolio, except when <a href="/bot-doc/en/docs/params-description.html#p.always_limits_timer">Always timer</a> is enabled.</p> <p>The rules for moving signal prices can be divided into two cases: a sale occurred in the <a href="/bot-doc/en/docs/params-description.html#s.is_first">Is first</a> instrument and a purchase occurred in the <a href="/bot-doc/en/docs/params-description.html#s.is_first">Is first</a> instrument. Within each of these cases, the algorithm is further split into two subcases: the portfolio position before the trade was zero or non-zero.</p> <p>We define the following notation:</p> <ul><li><p><code>diffpos</code> - signed lot quantity in the trade of the <a href="/bot-doc/en/docs/params-description.html#s.is_first">Is first</a> instrument;</p></li> <li><p><code>V</code> - <a href="/bot-doc/en/docs/params-description.html#p.v_in_l">v_in_left</a> × <a href="/bot-doc/en/docs/params-description.html#s.count">Count</a> or <a href="/bot-doc/en/docs/params-description.html#p.v_out_l">v_out_left</a> × <a href="/bot-doc/en/docs/params-description.html#s.count">Count</a>, depending on whether the order opens or closes a position;</p></li> <li><p><a href="/bot-doc/en/docs/params-description.html#s.count">Count</a> - <code>Count</code> of the <a href="/bot-doc/en/docs/params-description.html#s.is_first">Is first</a> instrument;</p></li> <li><p><a href="/bot-doc/en/docs/params-description.html#s.pos">Curpos</a> - current position in the <a href="/bot-doc/en/docs/params-description.html#s.is_first">Is first</a> instrument of the portfolio (i.e., the just-executed trade is not yet included);</p></li> <li><p>subscript 0 - previous value of a parameter, subscript 1 — new value of a parameter.
With this notation, the algorithm for moving signal prices is as follows:</p></li> <li><p>if a sell trade has been executed (with a quantity of <code>diffpos</code>):</p> <ul><li><p>if the current position before the trade was <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>c</mi><mi>u</mi><mi>r</mi><mi>p</mi><mi>o</mi><mi>s</mi><mo>≠</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">curpos\neq 0</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="strut" style="height:0.716em;"></span><span class="strut bottom" style="height:0.9309999999999999em;vertical-align:-0.215em;"></span><span class="base textstyle uncramped"><span class="mord mathit">c</span><span class="mord mathit">u</span><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mord mathit">p</span><span class="mord mathit">o</span><span class="mord mathit">s</span><span class="mrel">≠</span><span class="mord mathrm">0</span></span></span></span>:</p> <p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>k</mi><mn>3</mn><mo>=</mo><mrow><mo fence="true">(</mo><mi mathvariant="normal">∣</mi><mrow><mi>L</mi><mi>i</mi><mi>m</mi><mi mathvariant="normal">_</mi><mi>S</mi><mi>e</mi><mi>l</mi><msub><mi>l</mi><mn>0</mn></msub><mo>−</mo><mi>L</mi><mi>i</mi><mi>m</mi><mi mathvariant="normal">_</mi><mi>B</mi><mi>u</mi><msub><mi>y</mi><mn>0</mn></msub></mrow><mi mathvariant="normal">∣</mi><mo>−</mo><mi>T</mi><mi>P</mi><mo>−</mo><mi>K</mi><mo fence="true">)</mo></mrow><mo>×</mo><mfrac><mrow><mi>V</mi></mrow><mrow><mi>c</mi><mi>u</mi><mi>r</mi><mi>p</mi><mi>o</mi><mi>s</mi></mrow></mfrac><mo separator="true">,</mo></mrow><annotation encoding="application/x-tex">k3=\left(|{Lim\_Sell_0- Lim\_Buy_0}|-TP-K\right)\times\frac{V}{curpos},</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="strut" style="height:0.872331em;"></span><span class="strut bottom" style="height:1.3534389999999998em;vertical-align:-0.481108em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.03148em;">k</span><span class="mord mathrm">3</span><span class="mrel">=</span><span class="minner textstyle uncramped"><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;"><span class="delimsizing size1">(</span></span><span class="mord mathrm">∣</span><span class="mord textstyle uncramped"><span class="mord mathit">L</span><span class="mord mathit">i</span><span class="mord mathit">m</span><span class="mord mathrm" style="margin-right:0.02778em;">_</span><span class="mord mathit" style="margin-right:0.05764em;">S</span><span class="mord mathit">e</span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mord"><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.01968em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">0</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mbin">−</span><span class="mord mathit">L</span><span class="mord mathit">i</span><span class="mord mathit">m</span><span class="mord mathrm" style="margin-right:0.02778em;">_</span><span class="mord mathit" style="margin-right:0.05017em;">B</span><span class="mord mathit">u</span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">0</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span><span class="mord mathrm">∣</span><span class="mbin">−</span><span class="mord mathit" style="margin-right:0.13889em;">T</span><span class="mord mathit" style="margin-right:0.13889em;">P</span><span class="mbin">−</span><span class="mord mathit" style="margin-right:0.07153em;">K</span><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;"><span class="delimsizing size1">)</span></span></span><span class="mbin">×</span><span class="mord reset-textstyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.345em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit">c</span><span class="mord mathit">u</span><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mord mathit">p</span><span class="mord mathit">o</span><span class="mord mathit">s</span></span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.394em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord mathit" style="margin-right:0.22222em;">V</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span><span class="mpunct">,</span></span></span></span></p> <p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>k</mi><mn>4</mn><mo>=</mo><mrow><mo fence="true">{</mo><mtable><mtr><mtd><mrow><mi>k</mi><mn>3</mn><mo>+</mo><mi>K</mi><mn>2</mn><mo separator="true">,</mo></mrow></mtd><mtd><mrow><mtext><mi mathvariant="normal">i</mi><mi mathvariant="normal">f</mi></mtext><mspace width="0.5em"></mspace><mi>L</mi><mi>i</mi><mi>m</mi><mi mathvariant="normal">_</mi><mi>S</mi><mi>e</mi><mi>l</mi><msub><mi>l</mi><mn>0</mn></msub><mo>−</mo><mi>L</mi><mi>i</mi><mi>m</mi><mi mathvariant="normal">_</mi><mi>B</mi><mi>u</mi><msub><mi>y</mi><mn>0</mn></msub><mo>≥</mo><mn>0</mn></mrow></mtd></mtr><mtr><mtd><mrow><mo>−</mo><mi>k</mi><mn>3</mn><mo>+</mo><mi>K</mi><mn>2</mn><mo separator="true">,</mo></mrow></mtd><mtd><mrow><mtext><mi mathvariant="normal">i</mi><mi mathvariant="normal">f</mi></mtext><mspace width="0.5em"></mspace><mi>L</mi><mi>i</mi><mi>m</mi><mi mathvariant="normal">_</mi><mi>S</mi><mi>e</mi><mi>l</mi><msub><mi>l</mi><mn>0</mn></msub><mo>−</mo><mi>L</mi><mi>i</mi><mi>m</mi><mi mathvariant="normal">_</mi><mi>B</mi><mi>u</mi><msub><mi>y</mi><mn>0</mn></msub><mo>&lt;</mo><mn>0</mn></mrow></mtd></mtr></mtable></mrow><mo separator="true">,</mo></mrow><annotation encoding="application/x-tex">k4=
\begin{cases}k3+K2, &amp;\text{if}\enspace Lim\_Sell_0-Lim\_Buy_0\geq 0\\
        -k3+K2, &amp;\text{if}\enspace Lim\_Sell_0-Lim\_Buy_0&lt;0 
\end{cases},</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="strut" style="height:1.75em;"></span><span class="strut bottom" style="height:3.0000299999999998em;vertical-align:-1.25003em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.03148em;">k</span><span class="mord mathrm">4</span><span class="mrel">=</span><span class="minner textstyle uncramped"><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;"><span class="delimsizing size4">{</span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist"><span style="top:-0.6819999999999999em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord textstyle uncramped"><span class="mord mathit" style="margin-right:0.03148em;">k</span><span class="mord mathrm">3</span><span class="mbin">+</span><span class="mord mathit" style="margin-right:0.07153em;">K</span><span class="mord mathrm">2</span><span class="mpunct">,</span></span></span><span style="top:0.7579999999999999em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord textstyle uncramped"><span class="mord">−</span><span class="mord mathit" style="margin-right:0.03148em;">k</span><span class="mord mathrm">3</span><span class="mbin">+</span><span class="mord mathit" style="margin-right:0.07153em;">K</span><span class="mord mathrm">2</span><span class="mpunct">,</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist"><span style="top:-0.6819999999999999em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord textstyle uncramped"><span class="text mord textstyle uncramped"><span class="mord mathrm">i</span><span class="mord mathrm" style="margin-right:0.07778em;">f</span></span><span class="mord mspace enspace"></span><span class="mord mathit">L</span><span class="mord mathit">i</span><span class="mord mathit">m</span><span class="mord mathrm" style="margin-right:0.02778em;">_</span><span class="mord mathit" style="margin-right:0.05764em;">S</span><span class="mord mathit">e</span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mord"><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.01968em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">0</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mbin">−</span><span class="mord mathit">L</span><span class="mord mathit">i</span><span class="mord mathit">m</span><span class="mord mathrm" style="margin-right:0.02778em;">_</span><span class="mord mathit" style="margin-right:0.05017em;">B</span><span class="mord mathit">u</span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">0</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">≥</span><span class="mord mathrm">0</span></span></span><span style="top:0.7579999999999999em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord textstyle uncramped"><span class="text mord textstyle uncramped"><span class="mord mathrm">i</span><span class="mord mathrm" style="margin-right:0.07778em;">f</span></span><span class="mord mspace enspace"></span><span class="mord mathit">L</span><span class="mord mathit">i</span><span class="mord mathit">m</span><span class="mord mathrm" style="margin-right:0.02778em;">_</span><span class="mord mathit" style="margin-right:0.05764em;">S</span><span class="mord mathit">e</span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mord"><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.01968em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">0</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mbin">−</span><span class="mord mathit">L</span><span class="mord mathit">i</span><span class="mord mathit">m</span><span class="mord mathrm" style="margin-right:0.02778em;">_</span><span class="mord mathit" style="margin-right:0.05017em;">B</span><span class="mord mathit">u</span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">0</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">&lt;</span><span class="mord mathrm">0</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span><span class="mpunct">,</span></span></span></span></p> <p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>L</mi><mi>i</mi><mi>m</mi><mi mathvariant="normal">_</mi><mi>B</mi><mi>u</mi><msub><mi>y</mi><mn>1</mn></msub><mo>=</mo><mi>L</mi><mi>i</mi><mi>m</mi><mi mathvariant="normal">_</mi><mi>B</mi><mi>u</mi><msub><mi>y</mi><mn>0</mn></msub><mo>+</mo><mfrac><mrow><mi mathvariant="normal">∣</mi><mrow><mi>d</mi><mi>i</mi><mi>f</mi><mi>f</mi><mi>p</mi><mi>o</mi><mi>s</mi></mrow><mi mathvariant="normal">∣</mi></mrow><mrow><mi>V</mi></mrow></mfrac><mo>×</mo><mrow><mo fence="true">{</mo><mtable><mtr><mtd><mrow><mi>k</mi><mn>4</mn><mo separator="true">,</mo></mrow></mtd><mtd><mrow><mtext><mi mathvariant="normal">i</mi><mi mathvariant="normal">f</mi></mtext><mspace width="0.5em"></mspace><mi>c</mi><mi>u</mi><mi>r</mi><mi>p</mi><mi>o</mi><mi>s</mi><mo>&gt;</mo><mn>0</mn></mrow></mtd></mtr><mtr><mtd><mrow><mi>K</mi><mn>1</mn><mo separator="true">,</mo></mrow></mtd><mtd><mrow><mtext><mi mathvariant="normal">i</mi><mi mathvariant="normal">f</mi></mtext><mspace width="0.5em"></mspace><mi>c</mi><mi>u</mi><mi>r</mi><mi>p</mi><mi>o</mi><mi>s</mi><mo>&lt;</mo><mn>0</mn></mrow></mtd></mtr></mtable></mrow><mo separator="true">,</mo></mrow><annotation encoding="application/x-tex">Lim\_Buy_1= Lim\_Buy_0+\frac{|{diffpos}|}{V}\times 
\begin{cases} 
 k4, &amp;\text{if}\enspace curpos&gt;0\\ 
 K1, &amp;\text{if}\enspace curpos&lt;0 
\end{cases},</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="strut" style="height:1.75em;"></span><span class="strut bottom" style="height:3.0000299999999998em;vertical-align:-1.25003em;"></span><span class="base textstyle uncramped"><span class="mord mathit">L</span><span class="mord mathit">i</span><span class="mord mathit">m</span><span class="mord mathrm" style="margin-right:0.02778em;">_</span><span class="mord mathit" style="margin-right:0.05017em;">B</span><span class="mord mathit">u</span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">1</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord mathit">L</span><span class="mord mathit">i</span><span class="mord mathit">m</span><span class="mord mathrm" style="margin-right:0.02778em;">_</span><span class="mord mathit" style="margin-right:0.05017em;">B</span><span class="mord mathit">u</span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">0</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mbin">+</span><span class="mord reset-textstyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.345em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit" style="margin-right:0.22222em;">V</span></span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.485em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord mathrm">∣</span><span class="mord scriptstyle uncramped"><span class="mord mathit">d</span><span class="mord mathit">i</span><span class="mord mathit" style="margin-right:0.10764em;">f</span><span class="mord mathit" style="margin-right:0.10764em;">f</span><span class="mord mathit">p</span><span class="mord mathit">o</span><span class="mord mathit">s</span></span><span class="mord mathrm">∣</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span><span class="mbin">×</span><span class="minner textstyle uncramped"><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;"><span class="delimsizing size4">{</span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist"><span style="top:-0.6819999999999999em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord textstyle uncramped"><span class="mord mathit" style="margin-right:0.03148em;">k</span><span class="mord mathrm">4</span><span class="mpunct">,</span></span></span><span style="top:0.7579999999999999em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord textstyle uncramped"><span class="mord mathit" style="margin-right:0.07153em;">K</span><span class="mord mathrm">1</span><span class="mpunct">,</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist"><span style="top:-0.6819999999999999em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord textstyle uncramped"><span class="text mord textstyle uncramped"><span class="mord mathrm">i</span><span class="mord mathrm" style="margin-right:0.07778em;">f</span></span><span class="mord mspace enspace"></span><span class="mord mathit">c</span><span class="mord mathit">u</span><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mord mathit">p</span><span class="mord mathit">o</span><span class="mord mathit">s</span><span class="mrel">&gt;</span><span class="mord mathrm">0</span></span></span><span style="top:0.7579999999999999em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord textstyle uncramped"><span class="text mord textstyle uncramped"><span class="mord mathrm">i</span><span class="mord mathrm" style="margin-right:0.07778em;">f</span></span><span class="mord mspace enspace"></span><span class="mord mathit">c</span><span class="mord mathit">u</span><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mord mathit">p</span><span class="mord mathit">o</span><span class="mord mathit">s</span><span class="mrel">&lt;</span><span class="mord mathrm">0</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span><span class="mpunct">,</span></span></span></span></p> <p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>L</mi><mi>i</mi><mi>m</mi><mi mathvariant="normal">_</mi><mi>S</mi><mi>e</mi><mi>l</mi><msub><mi>l</mi><mn>1</mn></msub><mo>=</mo><mi>L</mi><mi>i</mi><mi>m</mi><mi mathvariant="normal">_</mi><mi>S</mi><mi>e</mi><mi>l</mi><msub><mi>l</mi><mn>0</mn></msub><mo>+</mo><mfrac><mrow><mi mathvariant="normal">∣</mi><mrow><mi>d</mi><mi>i</mi><mi>f</mi><mi>f</mi><mi>p</mi><mi>o</mi><mi>s</mi></mrow><mi mathvariant="normal">∣</mi></mrow><mrow><mi>V</mi></mrow></mfrac><mo>×</mo><mrow><mo fence="true">{</mo><mtable><mtr><mtd><mrow><mi>K</mi><mn>2</mn><mo separator="true">,</mo></mrow></mtd><mtd><mrow><mtext><mi mathvariant="normal">i</mi><mi mathvariant="normal">f</mi></mtext><mspace width="0.5em"></mspace><mi>c</mi><mi>u</mi><mi>r</mi><mi>p</mi><mi>o</mi><mi>s</mi><mo>&gt;</mo><mn>0</mn></mrow></mtd></mtr><mtr><mtd><mrow><mi>K</mi><mo separator="true">,</mo></mrow></mtd><mtd><mrow><mtext><mi mathvariant="normal">i</mi><mi mathvariant="normal">f</mi></mtext><mspace width="0.5em"></mspace><mi>c</mi><mi>u</mi><mi>r</mi><mi>p</mi><mi>o</mi><mi>s</mi><mo>&lt;</mo><mn>0</mn></mrow></mtd></mtr></mtable></mrow><mo separator="true">,</mo></mrow><annotation encoding="application/x-tex">Lim\_Sell_1=Lim\_Sell_0+\frac{|{diffpos}|}{V}\times
\begin{cases} 
K2, &amp;\text{if}\enspace curpos&gt;0\\ 
K, &amp;\text{if}\enspace curpos&lt;0 
\end{cases},</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="strut" style="height:1.75em;"></span><span class="strut bottom" style="height:3.0000299999999998em;vertical-align:-1.25003em;"></span><span class="base textstyle uncramped"><span class="mord mathit">L</span><span class="mord mathit">i</span><span class="mord mathit">m</span><span class="mord mathrm" style="margin-right:0.02778em;">_</span><span class="mord mathit" style="margin-right:0.05764em;">S</span><span class="mord mathit">e</span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mord"><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.01968em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">1</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord mathit">L</span><span class="mord mathit">i</span><span class="mord mathit">m</span><span class="mord mathrm" style="margin-right:0.02778em;">_</span><span class="mord mathit" style="margin-right:0.05764em;">S</span><span class="mord mathit">e</span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mord"><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.01968em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">0</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mbin">+</span><span class="mord reset-textstyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.345em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit" style="margin-right:0.22222em;">V</span></span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.485em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord mathrm">∣</span><span class="mord scriptstyle uncramped"><span class="mord mathit">d</span><span class="mord mathit">i</span><span class="mord mathit" style="margin-right:0.10764em;">f</span><span class="mord mathit" style="margin-right:0.10764em;">f</span><span class="mord mathit">p</span><span class="mord mathit">o</span><span class="mord mathit">s</span></span><span class="mord mathrm">∣</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span><span class="mbin">×</span><span class="minner textstyle uncramped"><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;"><span class="delimsizing size4">{</span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist"><span style="top:-0.6819999999999999em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord textstyle uncramped"><span class="mord mathit" style="margin-right:0.07153em;">K</span><span class="mord mathrm">2</span><span class="mpunct">,</span></span></span><span style="top:0.7579999999999999em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord textstyle uncramped"><span class="mord mathit" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist"><span style="top:-0.6819999999999999em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord textstyle uncramped"><span class="text mord textstyle uncramped"><span class="mord mathrm">i</span><span class="mord mathrm" style="margin-right:0.07778em;">f</span></span><span class="mord mspace enspace"></span><span class="mord mathit">c</span><span class="mord mathit">u</span><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mord mathit">p</span><span class="mord mathit">o</span><span class="mord mathit">s</span><span class="mrel">&gt;</span><span class="mord mathrm">0</span></span></span><span style="top:0.7579999999999999em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord textstyle uncramped"><span class="text mord textstyle uncramped"><span class="mord mathrm">i</span><span class="mord mathrm" style="margin-right:0.07778em;">f</span></span><span class="mord mspace enspace"></span><span class="mord mathit">c</span><span class="mord mathit">u</span><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mord mathit">p</span><span class="mord mathit">o</span><span class="mord mathit">s</span><span class="mrel">&lt;</span><span class="mord mathrm">0</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span><span class="mpunct">,</span></span></span></span></p></li> <li><p>if the current position before the trade was <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>c</mi><mi>u</mi><mi>r</mi><mi>p</mi><mi>o</mi><mi>s</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">curpos=0</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="strut" style="height:0.64444em;"></span><span class="strut bottom" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="base textstyle uncramped"><span class="mord mathit">c</span><span class="mord mathit">u</span><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mord mathit">p</span><span class="mord mathit">o</span><span class="mord mathit">s</span><span class="mrel">=</span><span class="mord mathrm">0</span></span></span></span>:</p> <p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>L</mi><mi>i</mi><mi>m</mi><mi mathvariant="normal">_</mi><mi>S</mi><mi>e</mi><mi>l</mi><msub><mi>l</mi><mn>1</mn></msub><mo>=</mo><mi>L</mi><mi>i</mi><mi>m</mi><mi mathvariant="normal">_</mi><mi>S</mi><mi>e</mi><mi>l</mi><msub><mi>l</mi><mn>0</mn></msub><mo>+</mo><mfrac><mrow><mi mathvariant="normal">∣</mi><mrow><mi>d</mi><mi>i</mi><mi>f</mi><mi>f</mi><mi>p</mi><mi>o</mi><mi>s</mi></mrow><mi mathvariant="normal">∣</mi></mrow><mrow><mi>V</mi></mrow></mfrac><mo>×</mo><mi>K</mi><mo separator="true">,</mo></mrow><annotation encoding="application/x-tex">Lim\_Sell_1=Lim\_Sell_0+\frac{|{diffpos}|}{V}\times K,</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="strut" style="height:1.01em;"></span><span class="strut bottom" style="height:1.355em;vertical-align:-0.345em;"></span><span class="base textstyle uncramped"><span class="mord mathit">L</span><span class="mord mathit">i</span><span class="mord mathit">m</span><span class="mord mathrm" style="margin-right:0.02778em;">_</span><span class="mord mathit" style="margin-right:0.05764em;">S</span><span class="mord mathit">e</span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mord"><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.01968em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">1</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord mathit">L</span><span class="mord mathit">i</span><span class="mord mathit">m</span><span class="mord mathrm" style="margin-right:0.02778em;">_</span><span class="mord mathit" style="margin-right:0.05764em;">S</span><span class="mord mathit">e</span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mord"><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.01968em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">0</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mbin">+</span><span class="mord reset-textstyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.345em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit" style="margin-right:0.22222em;">V</span></span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.485em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord mathrm">∣</span><span class="mord scriptstyle uncramped"><span class="mord mathit">d</span><span class="mord mathit">i</span><span class="mord mathit" style="margin-right:0.10764em;">f</span><span class="mord mathit" style="margin-right:0.10764em;">f</span><span class="mord mathit">p</span><span class="mord mathit">o</span><span class="mord mathit">s</span></span><span class="mord mathrm">∣</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span><span class="mbin">×</span><span class="mord mathit" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span></span></span></span></p> <p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>L</mi><mi>i</mi><mi>m</mi><mi mathvariant="normal">_</mi><mi>B</mi><mi>u</mi><msub><mi>y</mi><mn>1</mn></msub><mo>=</mo><mi>L</mi><mi>i</mi><mi>m</mi><mi mathvariant="normal">_</mi><mi>S</mi><mi>e</mi><mi>l</mi><msub><mi>l</mi><mn>0</mn></msub><mo>−</mo><mi>T</mi><mi>P</mi><mo separator="true">,</mo></mrow><annotation encoding="application/x-tex">Lim\_Buy_1=Lim\_Sell_0-TP,</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="strut" style="height:0.69444em;"></span><span class="strut bottom" style="height:1.00444em;vertical-align:-0.31em;"></span><span class="base textstyle uncramped"><span class="mord mathit">L</span><span class="mord mathit">i</span><span class="mord mathit">m</span><span class="mord mathrm" style="margin-right:0.02778em;">_</span><span class="mord mathit" style="margin-right:0.05017em;">B</span><span class="mord mathit">u</span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">1</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord mathit">L</span><span class="mord mathit">i</span><span class="mord mathit">m</span><span class="mord mathrm" style="margin-right:0.02778em;">_</span><span class="mord mathit" style="margin-right:0.05764em;">S</span><span class="mord mathit">e</span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mord"><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.01968em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">0</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mbin">−</span><span class="mord mathit" style="margin-right:0.13889em;">T</span><span class="mord mathit" style="margin-right:0.13889em;">P</span><span class="mpunct">,</span></span></span></span></p></li></ul></li> <li><p>if a buy trade has been executed (with a quantity of <code>diffpos</code>):</p> <ul><li><p>if the current position before the trade was <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>c</mi><mi>u</mi><mi>r</mi><mi>p</mi><mi>o</mi><mi>s</mi><mo>≠</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">curpos\neq 0</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="strut" style="height:0.716em;"></span><span class="strut bottom" style="height:0.9309999999999999em;vertical-align:-0.215em;"></span><span class="base textstyle uncramped"><span class="mord mathit">c</span><span class="mord mathit">u</span><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mord mathit">p</span><span class="mord mathit">o</span><span class="mord mathit">s</span><span class="mrel">≠</span><span class="mord mathrm">0</span></span></span></span>:</p> <p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>k</mi><mn>3</mn><mo>=</mo><mrow><mo fence="true">(</mo><mi mathvariant="normal">∣</mi><mi>L</mi><mi>i</mi><mi>m</mi><mi mathvariant="normal">_</mi><mi>S</mi><mi>e</mi><mi>l</mi><msub><mi>l</mi><mn>0</mn></msub><mo>−</mo><mi>L</mi><mi>i</mi><mi>m</mi><mi mathvariant="normal">_</mi><mi>B</mi><mi>u</mi><msub><mi>y</mi><mn>0</mn></msub><mi mathvariant="normal">∣</mi><mo>−</mo><mi>T</mi><mi>P</mi><mo>−</mo><mi>K</mi><mo fence="true">)</mo></mrow><mo>×</mo><mfrac><mrow><mi>V</mi></mrow><mrow><mi>c</mi><mi>u</mi><mi>r</mi><mi>p</mi><mi>o</mi><mi>s</mi></mrow></mfrac><mo separator="true">,</mo></mrow><annotation encoding="application/x-tex">k3=\left(|Lim\_Sell_0-Lim\_Buy_0|-TP-K\right)\times\frac{V}{curpos},</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="strut" style="height:0.872331em;"></span><span class="strut bottom" style="height:1.3534389999999998em;vertical-align:-0.481108em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.03148em;">k</span><span class="mord mathrm">3</span><span class="mrel">=</span><span class="minner textstyle uncramped"><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;"><span class="delimsizing size1">(</span></span><span class="mord mathrm">∣</span><span class="mord mathit">L</span><span class="mord mathit">i</span><span class="mord mathit">m</span><span class="mord mathrm" style="margin-right:0.02778em;">_</span><span class="mord mathit" style="margin-right:0.05764em;">S</span><span class="mord mathit">e</span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mord"><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.01968em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">0</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mbin">−</span><span class="mord mathit">L</span><span class="mord mathit">i</span><span class="mord mathit">m</span><span class="mord mathrm" style="margin-right:0.02778em;">_</span><span class="mord mathit" style="margin-right:0.05017em;">B</span><span class="mord mathit">u</span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">0</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mord mathrm">∣</span><span class="mbin">−</span><span class="mord mathit" style="margin-right:0.13889em;">T</span><span class="mord mathit" style="margin-right:0.13889em;">P</span><span class="mbin">−</span><span class="mord mathit" style="margin-right:0.07153em;">K</span><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;"><span class="delimsizing size1">)</span></span></span><span class="mbin">×</span><span class="mord reset-textstyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.345em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit">c</span><span class="mord mathit">u</span><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mord mathit">p</span><span class="mord mathit">o</span><span class="mord mathit">s</span></span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.394em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord mathit" style="margin-right:0.22222em;">V</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span><span class="mpunct">,</span></span></span></span></p> <p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>k</mi><mn>4</mn><mo>=</mo><mrow><mo fence="true">{</mo><mtable><mtr><mtd><mrow><mo>−</mo><mi>k</mi><mn>3</mn><mo>+</mo><mi>K</mi><mn>2</mn><mo separator="true">,</mo></mrow></mtd><mtd><mrow><mtext><mi mathvariant="normal">i</mi><mi mathvariant="normal">f</mi></mtext><mspace width="0.5em"></mspace><mi>L</mi><mi>i</mi><mi>m</mi><mi mathvariant="normal">_</mi><mi>S</mi><mi>e</mi><mi>l</mi><msub><mi>l</mi><mn>0</mn></msub><mo>−</mo><mi>L</mi><mi>i</mi><mi>m</mi><mi mathvariant="normal">_</mi><mi>B</mi><mi>u</mi><msub><mi>y</mi><mn>0</mn></msub><mo>≥</mo><mn>0</mn></mrow></mtd></mtr><mtr><mtd><mrow><mi>k</mi><mn>3</mn><mo>+</mo><mi>K</mi><mn>2</mn><mo separator="true">,</mo></mrow></mtd><mtd><mrow><mtext><mi mathvariant="normal">i</mi><mi mathvariant="normal">f</mi></mtext><mspace width="0.5em"></mspace><mi>L</mi><mi>i</mi><mi>m</mi><mi mathvariant="normal">_</mi><mi>S</mi><mi>e</mi><mi>l</mi><msub><mi>l</mi><mn>0</mn></msub><mo>−</mo><mi>L</mi><mi>i</mi><mi>m</mi><mi mathvariant="normal">_</mi><mi>B</mi><mi>u</mi><msub><mi>y</mi><mn>0</mn></msub><mo>&lt;</mo><mn>0</mn></mrow></mtd></mtr></mtable></mrow><mo separator="true">,</mo></mrow><annotation encoding="application/x-tex">k4=
\begin{cases} 
-k3+K2, &amp;\text{if}\enspace Lim\_Sell_0-Lim\_Buy_0\geq 0\\
k3+K2, &amp;\text{if}\enspace Lim\_Sell_0-Lim\_Buy_0&lt;0
\end{cases},</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="strut" style="height:1.75em;"></span><span class="strut bottom" style="height:3.0000299999999998em;vertical-align:-1.25003em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.03148em;">k</span><span class="mord mathrm">4</span><span class="mrel">=</span><span class="minner textstyle uncramped"><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;"><span class="delimsizing size4">{</span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist"><span style="top:-0.6819999999999999em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord textstyle uncramped"><span class="mord">−</span><span class="mord mathit" style="margin-right:0.03148em;">k</span><span class="mord mathrm">3</span><span class="mbin">+</span><span class="mord mathit" style="margin-right:0.07153em;">K</span><span class="mord mathrm">2</span><span class="mpunct">,</span></span></span><span style="top:0.7579999999999999em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord textstyle uncramped"><span class="mord mathit" style="margin-right:0.03148em;">k</span><span class="mord mathrm">3</span><span class="mbin">+</span><span class="mord mathit" style="margin-right:0.07153em;">K</span><span class="mord mathrm">2</span><span class="mpunct">,</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist"><span style="top:-0.6819999999999999em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord textstyle uncramped"><span class="text mord textstyle uncramped"><span class="mord mathrm">i</span><span class="mord mathrm" style="margin-right:0.07778em;">f</span></span><span class="mord mspace enspace"></span><span class="mord mathit">L</span><span class="mord mathit">i</span><span class="mord mathit">m</span><span class="mord mathrm" style="margin-right:0.02778em;">_</span><span class="mord mathit" style="margin-right:0.05764em;">S</span><span class="mord mathit">e</span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mord"><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.01968em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">0</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mbin">−</span><span class="mord mathit">L</span><span class="mord mathit">i</span><span class="mord mathit">m</span><span class="mord mathrm" style="margin-right:0.02778em;">_</span><span class="mord mathit" style="margin-right:0.05017em;">B</span><span class="mord mathit">u</span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">0</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">≥</span><span class="mord mathrm">0</span></span></span><span style="top:0.7579999999999999em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord textstyle uncramped"><span class="text mord textstyle uncramped"><span class="mord mathrm">i</span><span class="mord mathrm" style="margin-right:0.07778em;">f</span></span><span class="mord mspace enspace"></span><span class="mord mathit">L</span><span class="mord mathit">i</span><span class="mord mathit">m</span><span class="mord mathrm" style="margin-right:0.02778em;">_</span><span class="mord mathit" style="margin-right:0.05764em;">S</span><span class="mord mathit">e</span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mord"><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.01968em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">0</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mbin">−</span><span class="mord mathit">L</span><span class="mord mathit">i</span><span class="mord mathit">m</span><span class="mord mathrm" style="margin-right:0.02778em;">_</span><span class="mord mathit" style="margin-right:0.05017em;">B</span><span class="mord mathit">u</span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">0</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">&lt;</span><span class="mord mathrm">0</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span><span class="mpunct">,</span></span></span></span></p> <p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>L</mi><mi>i</mi><mi>m</mi><mi mathvariant="normal">_</mi><mi>S</mi><mi>e</mi><mi>l</mi><msub><mi>l</mi><mn>1</mn></msub><mo>=</mo><mi>L</mi><mi>i</mi><mi>m</mi><mi mathvariant="normal">_</mi><mi>S</mi><mi>e</mi><mi>l</mi><msub><mi>l</mi><mn>0</mn></msub><mo>−</mo><mfrac><mrow><mi mathvariant="normal">∣</mi><mrow><mi>d</mi><mi>i</mi><mi>f</mi><mi>f</mi><mi>p</mi><mi>o</mi><mi>s</mi></mrow><mi mathvariant="normal">∣</mi></mrow><mrow><mi>V</mi></mrow></mfrac><mo>×</mo><mrow><mo fence="true">{</mo><mtable><mtr><mtd><mrow><mi>k</mi><mn>4</mn><mo separator="true">,</mo></mrow></mtd><mtd><mrow><mtext><mi mathvariant="normal">i</mi><mi mathvariant="normal">f</mi></mtext><mspace width="0.5em"></mspace><mi>c</mi><mi>u</mi><mi>r</mi><mi>p</mi><mi>o</mi><mi>s</mi><mo>&lt;</mo><mn>0</mn></mrow></mtd></mtr><mtr><mtd><mrow><mi>K</mi><mn>1</mn><mo separator="true">,</mo></mrow></mtd><mtd><mrow><mtext><mi mathvariant="normal">i</mi><mi mathvariant="normal">f</mi></mtext><mspace width="0.5em"></mspace><mi>c</mi><mi>u</mi><mi>r</mi><mi>p</mi><mi>o</mi><mi>s</mi><mo>&gt;</mo><mn>0</mn></mrow></mtd></mtr></mtable></mrow><mo separator="true">,</mo></mrow><annotation encoding="application/x-tex">Lim\_Sell_1=Lim\_Sell_0-\frac{|{diffpos}|}{V}\times 
\begin{cases} 
k4, &amp;\text{if}\enspace curpos&lt;0\\
K1, &amp;\text{if}\enspace curpos&gt;0 
\end{cases},</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="strut" style="height:1.75em;"></span><span class="strut bottom" style="height:3.0000299999999998em;vertical-align:-1.25003em;"></span><span class="base textstyle uncramped"><span class="mord mathit">L</span><span class="mord mathit">i</span><span class="mord mathit">m</span><span class="mord mathrm" style="margin-right:0.02778em;">_</span><span class="mord mathit" style="margin-right:0.05764em;">S</span><span class="mord mathit">e</span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mord"><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.01968em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">1</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord mathit">L</span><span class="mord mathit">i</span><span class="mord mathit">m</span><span class="mord mathrm" style="margin-right:0.02778em;">_</span><span class="mord mathit" style="margin-right:0.05764em;">S</span><span class="mord mathit">e</span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mord"><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.01968em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">0</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mbin">−</span><span class="mord reset-textstyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.345em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit" style="margin-right:0.22222em;">V</span></span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.485em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord mathrm">∣</span><span class="mord scriptstyle uncramped"><span class="mord mathit">d</span><span class="mord mathit">i</span><span class="mord mathit" style="margin-right:0.10764em;">f</span><span class="mord mathit" style="margin-right:0.10764em;">f</span><span class="mord mathit">p</span><span class="mord mathit">o</span><span class="mord mathit">s</span></span><span class="mord mathrm">∣</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span><span class="mbin">×</span><span class="minner textstyle uncramped"><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;"><span class="delimsizing size4">{</span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist"><span style="top:-0.6819999999999999em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord textstyle uncramped"><span class="mord mathit" style="margin-right:0.03148em;">k</span><span class="mord mathrm">4</span><span class="mpunct">,</span></span></span><span style="top:0.7579999999999999em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord textstyle uncramped"><span class="mord mathit" style="margin-right:0.07153em;">K</span><span class="mord mathrm">1</span><span class="mpunct">,</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist"><span style="top:-0.6819999999999999em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord textstyle uncramped"><span class="text mord textstyle uncramped"><span class="mord mathrm">i</span><span class="mord mathrm" style="margin-right:0.07778em;">f</span></span><span class="mord mspace enspace"></span><span class="mord mathit">c</span><span class="mord mathit">u</span><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mord mathit">p</span><span class="mord mathit">o</span><span class="mord mathit">s</span><span class="mrel">&lt;</span><span class="mord mathrm">0</span></span></span><span style="top:0.7579999999999999em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord textstyle uncramped"><span class="text mord textstyle uncramped"><span class="mord mathrm">i</span><span class="mord mathrm" style="margin-right:0.07778em;">f</span></span><span class="mord mspace enspace"></span><span class="mord mathit">c</span><span class="mord mathit">u</span><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mord mathit">p</span><span class="mord mathit">o</span><span class="mord mathit">s</span><span class="mrel">&gt;</span><span class="mord mathrm">0</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span><span class="mpunct">,</span></span></span></span></p> <p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>L</mi><mi>i</mi><mi>m</mi><mi mathvariant="normal">_</mi><mi>B</mi><mi>u</mi><msub><mi>y</mi><mn>1</mn></msub><mo>=</mo><mi>L</mi><mi>i</mi><mi>m</mi><mi mathvariant="normal">_</mi><mi>B</mi><mi>u</mi><msub><mi>y</mi><mn>0</mn></msub><mo>−</mo><mfrac><mrow><mi mathvariant="normal">∣</mi><mrow><mi>d</mi><mi>i</mi><mi>f</mi><mi>f</mi><mi>p</mi><mi>o</mi><mi>s</mi></mrow><mi mathvariant="normal">∣</mi></mrow><mrow><mi>V</mi></mrow></mfrac><mo>×</mo><mrow><mo fence="true">{</mo><mtable><mtr><mtd><mrow><mi>K</mi><mn>2</mn><mo separator="true">,</mo></mrow></mtd><mtd><mrow><mtext><mi mathvariant="normal">i</mi><mi mathvariant="normal">f</mi></mtext><mspace width="0.5em"></mspace><mi>c</mi><mi>u</mi><mi>r</mi><mi>p</mi><mi>o</mi><mi>s</mi><mo>&lt;</mo><mn>0</mn></mrow></mtd></mtr><mtr><mtd><mrow><mi>K</mi><mo separator="true">,</mo></mrow></mtd><mtd><mrow><mtext><mi mathvariant="normal">i</mi><mi mathvariant="normal">f</mi></mtext><mspace width="0.5em"></mspace><mi>c</mi><mi>u</mi><mi>r</mi><mi>p</mi><mi>o</mi><mi>s</mi><mo>&gt;</mo><mn>0</mn></mrow></mtd></mtr></mtable></mrow><mo separator="true">,</mo></mrow><annotation encoding="application/x-tex">Lim\_Buy_1=Lim\_Buy_0-\frac{|{diffpos}|}{V}\times 
\begin{cases} 
K2, &amp;\text{if}\enspace curpos&lt;0\\
K, &amp;\text{if}\enspace curpos&gt;0 
\end{cases},</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="strut" style="height:1.75em;"></span><span class="strut bottom" style="height:3.0000299999999998em;vertical-align:-1.25003em;"></span><span class="base textstyle uncramped"><span class="mord mathit">L</span><span class="mord mathit">i</span><span class="mord mathit">m</span><span class="mord mathrm" style="margin-right:0.02778em;">_</span><span class="mord mathit" style="margin-right:0.05017em;">B</span><span class="mord mathit">u</span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">1</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord mathit">L</span><span class="mord mathit">i</span><span class="mord mathit">m</span><span class="mord mathrm" style="margin-right:0.02778em;">_</span><span class="mord mathit" style="margin-right:0.05017em;">B</span><span class="mord mathit">u</span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">0</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mbin">−</span><span class="mord reset-textstyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.345em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit" style="margin-right:0.22222em;">V</span></span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.485em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord mathrm">∣</span><span class="mord scriptstyle uncramped"><span class="mord mathit">d</span><span class="mord mathit">i</span><span class="mord mathit" style="margin-right:0.10764em;">f</span><span class="mord mathit" style="margin-right:0.10764em;">f</span><span class="mord mathit">p</span><span class="mord mathit">o</span><span class="mord mathit">s</span></span><span class="mord mathrm">∣</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span><span class="mbin">×</span><span class="minner textstyle uncramped"><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;"><span class="delimsizing size4">{</span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist"><span style="top:-0.6819999999999999em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord textstyle uncramped"><span class="mord mathit" style="margin-right:0.07153em;">K</span><span class="mord mathrm">2</span><span class="mpunct">,</span></span></span><span style="top:0.7579999999999999em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord textstyle uncramped"><span class="mord mathit" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist"><span style="top:-0.6819999999999999em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord textstyle uncramped"><span class="text mord textstyle uncramped"><span class="mord mathrm">i</span><span class="mord mathrm" style="margin-right:0.07778em;">f</span></span><span class="mord mspace enspace"></span><span class="mord mathit">c</span><span class="mord mathit">u</span><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mord mathit">p</span><span class="mord mathit">o</span><span class="mord mathit">s</span><span class="mrel">&lt;</span><span class="mord mathrm">0</span></span></span><span style="top:0.7579999999999999em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord textstyle uncramped"><span class="text mord textstyle uncramped"><span class="mord mathrm">i</span><span class="mord mathrm" style="margin-right:0.07778em;">f</span></span><span class="mord mspace enspace"></span><span class="mord mathit">c</span><span class="mord mathit">u</span><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mord mathit">p</span><span class="mord mathit">o</span><span class="mord mathit">s</span><span class="mrel">&gt;</span><span class="mord mathrm">0</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span><span class="mpunct">,</span></span></span></span></p></li> <li><p>if the current position before the trade was <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>c</mi><mi>u</mi><mi>r</mi><mi>p</mi><mi>o</mi><mi>s</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">curpos=0</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="strut" style="height:0.64444em;"></span><span class="strut bottom" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="base textstyle uncramped"><span class="mord mathit">c</span><span class="mord mathit">u</span><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mord mathit">p</span><span class="mord mathit">o</span><span class="mord mathit">s</span><span class="mrel">=</span><span class="mord mathrm">0</span></span></span></span>:</p> <p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>L</mi><mi>i</mi><mi>m</mi><mi mathvariant="normal">_</mi><mi>S</mi><mi>e</mi><mi>l</mi><msub><mi>l</mi><mn>1</mn></msub><mo>=</mo><mi>L</mi><mi>i</mi><mi>m</mi><mi mathvariant="normal">_</mi><mi>B</mi><mi>u</mi><msub><mi>y</mi><mn>0</mn></msub><mo>+</mo><mi>T</mi><mi>P</mi><mo separator="true">,</mo></mrow><annotation encoding="application/x-tex">Lim\_Sell_1=Lim\_Buy_0+TP,</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="strut" style="height:0.69444em;"></span><span class="strut bottom" style="height:1.00444em;vertical-align:-0.31em;"></span><span class="base textstyle uncramped"><span class="mord mathit">L</span><span class="mord mathit">i</span><span class="mord mathit">m</span><span class="mord mathrm" style="margin-right:0.02778em;">_</span><span class="mord mathit" style="margin-right:0.05764em;">S</span><span class="mord mathit">e</span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mord"><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.01968em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">1</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord mathit">L</span><span class="mord mathit">i</span><span class="mord mathit">m</span><span class="mord mathrm" style="margin-right:0.02778em;">_</span><span class="mord mathit" style="margin-right:0.05017em;">B</span><span class="mord mathit">u</span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">0</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mbin">+</span><span class="mord mathit" style="margin-right:0.13889em;">T</span><span class="mord mathit" style="margin-right:0.13889em;">P</span><span class="mpunct">,</span></span></span></span></p> <p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>L</mi><mi>i</mi><mi>m</mi><mi mathvariant="normal">_</mi><mi>B</mi><mi>u</mi><msub><mi>y</mi><mn>1</mn></msub><mo>=</mo><mi>L</mi><mi>i</mi><mi>m</mi><mi mathvariant="normal">_</mi><mi>B</mi><mi>u</mi><msub><mi>y</mi><mn>0</mn></msub><mo>−</mo><mfrac><mrow><mi mathvariant="normal">∣</mi><mrow><mi>d</mi><mi>i</mi><mi>f</mi><mi>f</mi><mi>p</mi><mi>o</mi><mi>s</mi></mrow><mi mathvariant="normal">∣</mi></mrow><mrow><mi>V</mi></mrow></mfrac><mo>×</mo><mi>K</mi><mi mathvariant="normal">.</mi></mrow><annotation encoding="application/x-tex">Lim\_Buy_1=Lim\_Buy_0-\frac{|{diffpos}|}{V}\times K.</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="strut" style="height:1.01em;"></span><span class="strut bottom" style="height:1.355em;vertical-align:-0.345em;"></span><span class="base textstyle uncramped"><span class="mord mathit">L</span><span class="mord mathit">i</span><span class="mord mathit">m</span><span class="mord mathrm" style="margin-right:0.02778em;">_</span><span class="mord mathit" style="margin-right:0.05017em;">B</span><span class="mord mathit">u</span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">1</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord mathit">L</span><span class="mord mathit">i</span><span class="mord mathit">m</span><span class="mord mathrm" style="margin-right:0.02778em;">_</span><span class="mord mathit" style="margin-right:0.05017em;">B</span><span class="mord mathit">u</span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">0</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mbin">−</span><span class="mord reset-textstyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.345em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit" style="margin-right:0.22222em;">V</span></span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.485em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord mathrm">∣</span><span class="mord scriptstyle uncramped"><span class="mord mathit">d</span><span class="mord mathit">i</span><span class="mord mathit" style="margin-right:0.10764em;">f</span><span class="mord mathit" style="margin-right:0.10764em;">f</span><span class="mord mathit">p</span><span class="mord mathit">o</span><span class="mord mathit">s</span></span><span class="mord mathrm">∣</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span><span class="mbin">×</span><span class="mord mathit" style="margin-right:0.07153em;">K</span><span class="mord mathrm">.</span></span></span></span></p></li></ul></li></ul> <p>Signal price adjustment also occurs when an order cannot be placed due to restrictions defined by <a href="/bot-doc/en/docs/params-description.html#p.v_min">v_min</a>, <a href="/bot-doc/en/docs/params-description.html#p.v_max">v_max</a>, <a href="/bot-doc/en/docs/params-description.html#p.to0">To0</a>. If the bot cannot buy due to <a href="/bot-doc/en/docs/params-description.html#p.v_max">v_max</a> restrictions, then according to the portfolio parameters <a href="/bot-doc/en/docs/params-description.html#p.timer">Limits timer</a> and <a href="/bot-doc/en/docs/params-description.html#p.percent">Percent</a>, the <a href="/bot-doc/en/docs/params-description.html#p.lim_s">Lim_Sell</a> and <a href="/bot-doc/en/docs/params-description.html#p.lim_b">Lim_Buy</a> prices are decreased by the value of the portfolio parameter <a href="/bot-doc/en/docs/params-description.html#p.k">K</a>, If the bot cannot sell due to <a href="/bot-doc/en/docs/params-description.html#p.v_min">v_min</a> restrictions, then according to the portfolio parameters <a href="/bot-doc/en/docs/params-description.html#p.timer">Limits timer</a> and <a href="/bot-doc/en/docs/params-description.html#p.percent">Percent</a> the <a href="/bot-doc/en/docs/params-description.html#p.lim_s">Lim_Sell</a> and <a href="/bot-doc/en/docs/params-description.html#p.lim_b">Lim_Buy</a> values are increased by the value of the portfolio parameter <a href="/bot-doc/en/docs/params-description.html#p.k">K</a>.</p> <h2 id="_8-4-behavior-of-orders-re-posted-based-on-sl-or-timer" tabindex="-1"><a href="#_8-4-behavior-of-orders-re-posted-based-on-sl-or-timer" class="header-anchor">#</a> <div class="anchor-container"><span id="sl_timer" class="anchor-target"></span><span id="behavior-of-orders-re-posted-based-on-sl-or-timer" class="anchor-target"></span> <a href="#sl_timer" title="Копировать ссылку" class="anchor-link">#</a></div> 8.4. Behavior of Orders Re-Posted Based on SL or Timer</h2> <p>When the parameter <a href="/bot-doc/en/docs/params-description.html#s.k_sl">k_sl</a> is zero or positive,  orders placed due to the following events: re-posting due to triggering of the <a href="/bot-doc/en/docs/params-description.html#s.sl">SL</a> condition, re-posting due to triggering of the <a href="/bot-doc/en/docs/params-description.html#s.timer">Timer</a> condition, or position closing or leveling according to schedule settings or by clicking the <a href="/bot-doc/en/docs/params-description.html#p.to_market">To market</a> button, will be re-posted once per second until the order is filled,  trading is disabled via <a href="/bot-doc/en/docs/getting-started.html#portfolio_actions.hard_stop">Hard stop</a> or a submission error is received. Re-posting will occur at a price of <code>bid</code> - <a href="/bot-doc/en/docs/params-description.html#s.k_sl">k_sl</a> for sell orders and <code>offer</code> + <a href="/bot-doc/en/docs/params-description.html#s.k_sl">k_sl</a> for buy orders.</p> <p>This is an additional re-posting mechanism; it does not alter or depend on the existing settings of the <a href="/bot-doc/en/docs/params-description.html#s.timer">Timer</a> or <a href="/bot-doc/en/docs/params-description.html#s.te">TE</a> parameters. That is, it will be executed even if the <a href="/bot-doc/en/docs/params-description.html#s.te">TE</a> flag is disabled.</p> <h2 id="_8-5-financial-result-calculation" tabindex="-1"><a href="#_8-5-financial-result-calculation" class="header-anchor">#</a> <div class="anchor-container"><span id="financial-result-calculation" class="anchor-target"></span> <a href="#financial-result-calculation" title="Копировать ссылку" class="anchor-link">#</a></div> 8.5. Financial Result Calculation</h2> <p>The financial result (in the sense of a simple numeric value) is calculated based on trades, and there are no &quot;exotic&quot; edge cases related to its computation. However, there are cases where spreads will not appear in the financial result widgets (<a href="/bot-doc/en/docs/interface.html#finres_for_today">Finres for today</a> and <a href="/bot-doc/en/docs/interface.html#finres_history">Finres history</a>).
The key rule to remember is: a spread is displayed only if there is a trade in the <a href="/bot-doc/en/docs/params-description.html#s.is_first">Is first</a> instrument. If there is no such trade, no spread will be shown.
For example, if your position becomes skewed for any reason and you rebalance it by clicking the <a href="/bot-doc/en/docs/params-description.html#p.to_market">To market</a>button, you will not get a proper spread in these widgets. You will only see a single &quot;skewed&quot; spread entry that includes only the <a href="/bot-doc/en/docs/params-description.html#s.is_first">Is first</a> instrument.
As an example: during flood control, trades may be executed on the first leg while the second leg cannot be submitted. This leads to one-sided skewed spreads on the first leg. After clicking <a href="/bot-doc/en/docs/params-description.html#p.to_market">To market</a>button, trades on the second leg are executed (and correctly reflected in the financial result). However, since no matching trade occurs in the primary instrument, no spread is displayed in the table—although the financial result itself remains accurate.</p> <p>Another scenario occurs when the <a href="/bot-doc/en/docs/params-description.html#s.count">Count</a> value of the first leg exceeds the <a href="/bot-doc/en/docs/params-description.html#s.count">Count</a> value of the second leg. For example, suppose you are trading a currency (e.g., USD/RUB) against futures on the derivatives market, with the currency as the first leg. In this case, the currency has a <a href="/bot-doc/en/docs/params-description.html#s.count">Count</a> of 100, while the futures contract has a <a href="/bot-doc/en/docs/params-description.html#s.count">Count</a> of 1, meaning you hedge every 100 currency units with one futures contract.
You place an order for 100 currency contracts. Suppose 60 are filled. No spread will appear in the table, as it would be inherently skewed — the second leg has not been traded yet. Then another 50 are filled, and again, no spread will be displayed. You then place one futures contract, which gets executed (and is correctly reflected in the financial result). However, it remains unclear which trades this execution should be linked to. If linked to the most recent trade (i.e., the 50-lot fill), the resulting spread would be clearly skewed. Attempting to associate it with earlier trades is not feasible, as real-world scenarios may be more complex than this simplified example.</p> <h2 id="_8-6-on-pricing-of-second-leg-orders" tabindex="-1"><a href="#_8-6-on-pricing-of-second-leg-orders" class="header-anchor">#</a> <div class="anchor-container"><span id="on-pricing-of-second-leg-orders" class="anchor-target"></span> <a href="#on-pricing-of-second-leg-orders" title="Копировать ссылку" class="anchor-link">#</a></div> 8.6. On Pricing of Second-Leg Orders</h2> <p>Orders for second-leg instruments are priced as follows:</p> <ul><li>A buy order is placed at the best ask price plus the offset <a href="/bot-doc/en/docs/params-description.html#s.k">k</a> or plus <a href="/bot-doc/en/docs/params-description.html#s.k_sl">k_sl</a> if the order is re-posted due to a stop-loss trigger or similar event.</li> <li>A sell order is placed at the best bid price minus the offset <a href="/bot-doc/en/docs/params-description.html#s.k">k</a> or minus <a href="/bot-doc/en/docs/params-description.html#s.k_sl">k_sl</a>if the order is re-posted due to a stop-loss trigger or similar event.
The best bid and ask prices for second-leg instruments are frozen at the moment the order for the <a href="/bot-doc/en/docs/params-description.html#s.is_first">Is first</a> instrument is submitted. As a result, when a trade is executed on the <a href="/bot-doc/en/docs/params-description.html#s.is_first">Is first</a> instrument , all other instruments in the portfolio are quoted with offsets based not on the current market prices, but on the best prices at the time the first-leg order was placed.
The only exception is when the <a href="/bot-doc/en/docs/params-description.html#p.equal_prices">Equal price</a> parameter is enabled.</li></ul> <p>No alternative methods for pricing second-leg orders are supported beyond those described above.</p> <h2 id="_8-7-on-order-submission-volumes" tabindex="-1"><a href="#_8-7-on-order-submission-volumes" class="header-anchor">#</a> <div class="anchor-container"><span id="on-order-submission-volumes" class="anchor-target"></span> <a href="#on-order-submission-volumes" title="Копировать ссылку" class="anchor-link">#</a></div> 8.7. On Order Submission Volumes</h2> <p>For certain exchanges (e.g., Deribit), if the order volume is not a multiple of the lot size, the submitted volume is automatically rounded down to the nearest whole number of lots. For example, if the lot size is 10 and the order size is 25, the actual order placed on the exchange will have a volume of 20 (rounding is always performed downward). If, as a result of this rounding, the order volume becomes zero, you will receive the rejection error <code>REASON_ZERO_AMOUNT_TO_MULTIPLE</code>.</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/bot-doc/en/docs/params-description.html" class="prev">
        7. Parameters Description
      </a></span> <span class="next"><a href="/bot-doc/en/docs/order-error.html">
        9. Order Submission, Cancellation, and Modification Errors
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/bot-doc/assets/js/app.83ad7943.js" defer></script><script src="/bot-doc/assets/js/2.838bb34b.js" defer></script><script src="/bot-doc/assets/js/45.f472a853.js" defer></script><script src="/bot-doc/assets/js/26.6f356218.js" defer></script>
  </body>
</html>
